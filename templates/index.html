<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hybrid Pro Terminal - Data Fetcher with Downloads</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#1e40af;--accent:#06b6d4;--bg:#0f172a;--text:#f1f5f9;--text-sec:#cbd5e1}
        body{font-family:Inter,Segoe UI,sans-serif;background:linear-gradient(135deg,#010617,#0f172a);color:var(--text);line-height:1.6;min-height:100vh}
        header{background:linear-gradient(135deg,#1e3a8a,#1e40af);padding:20px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 8px 32px rgba(30,64,175,0.3)}
        h1{font-size:28px;font-weight:700;background:linear-gradient(135deg,var(--accent),#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .settings-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(96,165,250,0.3);color:var(--text);padding:10px 20px;border-radius:8px;cursor:pointer;transition:all 0.3s}
        .settings-btn:hover{background:rgba(96,165,250,0.1);border-color:var(--accent);transform:translateY(-2px)}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(1,6,23,0.8);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
        .modal.active{display:flex}
        .modal-content{background:linear-gradient(135deg,#0f172a,#1a2f5a);padding:40px;border-radius:16px;max-width:550px;width:90%;max-height:85vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.5);border:1px solid rgba(96,165,250,0.2)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid rgba(96,165,250,0.2)}
        .close-modal{background:none;border:none;color:var(--text-sec);font-size:28px;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:all 0.3s}
        .close-modal:hover{color:var(--accent);background:rgba(6,182,212,0.1)}
        .form-group{margin-bottom:25px}
        label{display:block;margin-bottom:10px;font-weight:600;color:var(--text);font-size:14px}
        input,select{width:100%;padding:14px 16px;background:rgba(15,23,42,0.5);border:2px solid rgba(96,165,250,0.2);border-radius:10px;color:var(--text);font-size:14px;font-family:inherit;transition:all 0.3s}
        input:focus,select:focus{outline:none;border-color:var(--accent);background:rgba(15,23,42,0.8);box-shadow:0 0 0 3px rgba(6,182,212,0.1)}
        button{background:linear-gradient(135deg,var(--primary),#3b82f6);color:white;padding:14px 28px;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.3s}
        button:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(30,64,175,0.4)}
        .btn-full{width:100%;margin-top:12px}
        .btn-download{background:linear-gradient(135deg,#059669,#10b981);margin-left:10px;font-size:13px;padding:12px 20px}
        .btn-download:hover{box-shadow:0 8px 20px rgba(16,185,129,0.4)}
        .btn-clear{background:linear-gradient(135deg,#dc2626,#ef4444);margin-top:12px}
        .btn-clear:hover{box-shadow:0 8px 20px rgba(220,38,38,0.4)}
        .download-section{background:rgba(16,185,129,0.1);border:2px solid #10b981;padding:20px;border-radius:12px;margin-top:20px;margin-bottom:20px}
        .download-section h3{color:#6ee7b7;margin-bottom:15px;font-size:16px}
        .download-btns{display:flex;gap:10px;flex-wrap:wrap}
        .status{padding:16px;border-radius:10px;margin-top:20px;font-size:14px;border:2px solid;animation:slideIn 0.3s}
        @keyframes slideIn{from{transform:translateX(-10px);opacity:0}to{transform:translateX(0);opacity:1}}
        .status.success{background:rgba(16,185,129,0.1);color:#6ee7b7;border-color:#10b981}
        .status.error{background:rgba(239,68,68,0.1);color:#fca5a5;border-color:#ef4444}
        .status.info{background:rgba(6,182,212,0.1);color:#67e8f9;border-color:var(--accent)}
        .container{max-width:1400px;margin:0 auto;padding:30px 20px}
        .tabs-wrapper{background:rgba(30,41,59,0.5);border-radius:14px;padding:8px;display:flex;gap:8px;margin-bottom:25px;flex-wrap:wrap;border:1px solid rgba(96,165,250,0.1)}
        .tab-btn{background:transparent;color:var(--text-sec);padding:12px 20px;border:none;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.3s}
        .tab-btn.active{background:linear-gradient(135deg,var(--primary),#3b82f6);color:white;box-shadow:0 4px 12px rgba(30,64,175,0.3)}
        .tab-btn:hover:not(.active){background:rgba(96,165,250,0.1);color:var(--text)}
        .tab-content{display:none;background:rgba(30,41,59,0.5);padding:30px;border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid rgba(96,165,250,0.1);animation:fadeIn 0.3s;backdrop-filter:blur(10px)}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .tab-content.active{display:block}
        .tab-content h2{font-size:24px;font-weight:700;margin-bottom:25px;display:flex;align-items:center;gap:12px}
        .tab-content h2 i{color:var(--accent)}
        .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px}
        .form-grid.full{grid-template-columns:1fr}
        .fetch-btn{background:linear-gradient(135deg,var(--accent),#0891b2);padding:16px 40px;font-size:16px;width:100%;margin-top:25px;font-weight:700}
        .fetch-btn:hover{box-shadow:0 8px 24px rgba(6,182,212,0.4)}
        .loading{display:none;text-align:center;padding:40px 20px}
        .loading.active{display:block}
        .spinner{border:4px solid rgba(96,165,250,0.2);border-top:4px solid var(--accent);border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .results{background:rgba(15,23,42,0.5);padding:25px;border-radius:12px;margin-top:25px;border:1px solid rgba(96,165,250,0.1)}
        .results.hidden{display:none}
        .results h3{color:var(--accent);margin-bottom:25px;font-size:18px;font-weight:700}
        .results-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;max-height:700px;overflow-y:auto}
        .result-card{background:linear-gradient(135deg,rgba(30,64,175,0.1),rgba(6,182,212,0.05));border:1px solid rgba(96,165,250,0.2);border-radius:10px;padding:20px;transition:all 0.3s}
        .result-card:hover{background:linear-gradient(135deg,rgba(30,64,175,0.15),rgba(6,182,212,0.1));border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 12px rgba(6,182,212,0.2)}
        .result-card-header{display:flex;align-items:center;gap:10px;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid rgba(96,165,250,0.2)}
        .result-card-header strong{color:var(--accent);font-size:14px;font-weight:700}
        .result-card table{width:100%;border-collapse:collapse;font-size:12px;margin-top:10px}
        .result-card th,.result-card td{padding:8px;text-align:left;border-bottom:1px solid rgba(96,165,250,0.1)}
        .result-card th{background:rgba(30,64,175,0.2);font-weight:700;color:var(--accent);font-size:11px}
        .result-card td{color:var(--text-sec);word-break:break-word;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .error-msg{color:#fca5a5;padding:16px;background:rgba(239,68,68,0.1);border-left:4px solid #ef4444;border-radius:8px;margin-top:20px;border:2px solid #ef4444}
        @media(max-width:768px){.form-grid{grid-template-columns:1fr}.results-container{grid-template-columns:1fr}.download-btns{flex-direction:column}.btn-download{margin-left:0;width:100%}}
    </style>
</head>
<body>
    <header>
        <h1>üìä Hybrid Pro Terminal - Data Fetcher</h1>
        <button class="settings-btn" onclick="openSettings()"><i class="fas fa-cog"></i> Settings</button>
    </header>
    
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>‚öôÔ∏è Configuration</h2><button class="close-modal" onclick="closeSettings()">√ó</button></div>
            
            <div class="form-group">
                <label><i class="fas fa-server"></i> Backend URL</label>
                <input type="text" id="backendUrl" placeholder="https://your-app.up.railway.app">
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-key"></i> EODHD API Key</label>
                <input type="text" id="eodhd_key" placeholder="Enter EODHD key">
            </div>
            <div class="form-group">
                <label><i class="fas fa-key"></i> Databento API Key</label>
                <input type="text" id="databento_key" placeholder="Enter Databento key (optional)">
            </div>
            <div class="form-group">
                <label><i class="fas fa-key"></i> Polygon API Key</label>
                <input type="text" id="polygon_key" placeholder="Enter Polygon key (optional)">
            </div>
            <div class="form-group">
                <label><i class="fas fa-key"></i> Theta Data API Key</label>
                <input type="text" id="theta_key" placeholder="Enter Theta Data key (optional)">
            </div>
            
            <button class="btn-full" onclick="saveSettings()"><i class="fas fa-save"></i> Save Keys</button>
            <button class="btn-full" onclick="testConnection()"><i class="fas fa-signal"></i> Test Connection</button>
            <button class="btn-full btn-clear" onclick="clearAllSettings()"><i class="fas fa-trash"></i> Clear All Data</button>
            <div id="settingsStatus"></div>
        </div>
    </div>
    
    <div class="container">
        <div class="tabs-wrapper">
            <button class="tab-btn active" onclick="switchTab('eodhd-historical')"><i class="fas fa-chart-line"></i> EODHD Historical</button>
            <button class="tab-btn" onclick="switchTab('eodhd-options')"><i class="fas fa-list"></i> EODHD Options</button>
            <button class="tab-btn" onclick="switchTab('databento')"><i class="fas fa-database"></i> Databento</button>
            <button class="tab-btn" onclick="switchTab('polygon')"><i class="fas fa-chart-bar"></i> Polygon</button>
            <button class="tab-btn" onclick="switchTab('theta')"><i class="fas fa-layer-group"></i> Theta Data</button>
        </div>
        
        <div id="eodhd-historical" class="tab-content active">
            <h2><i class="fas fa-history"></i> EODHD Historical Data</h2>
            <div class="form-grid">
                <div class="form-group"><label>Select Ticker</label><select id="eodhd_hist_ticker"><option>Loading...</option></select></div>
                <div></div>
                <div class="form-group"><label>Start Date</label><input type="date" id="eodhd_hist_start"></div>
                <div class="form-group"><label>End Date</label><input type="date" id="eodhd_hist_end"></div>
            </div>
            <button class="fetch-btn" onclick="fetchEODHDHistorical()"><i class="fas fa-download"></i> Fetch Data</button>
            <div id="eodhd-hist-loading" class="loading"><div class="spinner"></div><p>Fetching data...</p></div>
            <div id="eodhd-hist-results" class="results hidden"></div>
        </div>
        
        <div id="eodhd-options" class="tab-content">
            <h2><i class="fas fa-layer-group"></i> EODHD Options</h2>
            <div class="form-grid">
                <div class="form-group"><label>Select Options Ticker</label><select id="eodhd_opt_ticker"><option>Loading...</option></select></div>
                <div></div>
                <div class="form-group full"><label>Date</label><input type="date" id="eodhd_opt_date"></div>
            </div>
            <button class="fetch-btn" onclick="fetchEODHDOptions()"><i class="fas fa-download"></i> Fetch Options</button>
            <div id="eodhd-opt-loading" class="loading"><div class="spinner"></div><p>Fetching options...</p></div>
            <div id="eodhd-opt-results" class="results hidden"></div>
        </div>
        
        <div id="databento" class="tab-content">
            <h2><i class="fas fa-database"></i> Databento Data</h2>
            <div class="form-grid">
                <div class="form-group"><label>Select Ticker</label><select id="databento_ticker"><option>Loading...</option></select></div>
                <div class="form-group"><label>Dataset</label><select id="databento_dataset"><option>Loading...</option></select></div>
                <div class="form-group"><label>Schema</label><select id="databento_schema"><option>Loading...</option></select></div>
                <div></div>
                <div class="form-group"><label>Start Date</label><input type="date" id="databento_start"></div>
                <div class="form-group"><label>End Date</label><input type="date" id="databento_end"></div>
            </div>
            <button class="fetch-btn" onclick="fetchDatabento()"><i class="fas fa-download"></i> Fetch Data</button>
            <div id="databento-loading" class="loading"><div class="spinner"></div><p>Fetching...</p></div>
            <div id="databento-results" class="results hidden"></div>
        </div>
        
        <div id="polygon" class="tab-content">
            <h2><i class="fas fa-chart-bar"></i> Polygon Data</h2>
            <div class="form-grid">
                <div class="form-group"><label>Select Ticker</label><select id="polygon_ticker"><option>Loading...</option></select></div>
                <div class="form-group"><label>Timespan</label><select id="polygon_timespan"><option value="minute">Minute</option><option value="hour" selected>Hour</option><option value="day">Day</option></select></div>
                <div class="form-group"><label>Start Date</label><input type="date" id="polygon_start"></div>
                <div class="form-group"><label>End Date</label><input type="date" id="polygon_end"></div>
            </div>
            <button class="fetch-btn" onclick="fetchPolygon()"><i class="fas fa-download"></i> Fetch Data</button>
            <div id="polygon-loading" class="loading"><div class="spinner"></div><p>Fetching...</p></div>
            <div id="polygon-results" class="results hidden"></div>
        </div>
        
        <div id="theta" class="tab-content">
            <h2><i class="fas fa-layer-group"></i> Theta Data Options</h2>
            <div class="form-grid">
                <div class="form-group"><label>Select Ticker</label><select id="theta_ticker"><option>Loading...</option></select></div>
                <div class="form-group"><label>Option Type</label><select id="theta_option_type"><option value="occ">OCC (Historical Greeks)</option><option value="quote">Quote (Real-time)</option><option value="trade">Trade (Tick Data)</option></select></div>
                <div class="form-group"><label>Start Date</label><input type="date" id="theta_start"></div>
                <div class="form-group"><label>End Date</label><input type="date" id="theta_end"></div>
            </div>
            <button class="fetch-btn" onclick="fetchTheta()"><i class="fas fa-download"></i> Fetch Options</button>
            <div id="theta-loading" class="loading"><div class="spinner"></div><p>Fetching options with Greeks...</p></div>
            <div id="theta-results" class="results hidden"></div>
        </div>
    </div>
    
    <script>
        let API_BASE = "http://localhost:5000";
        let cachedData = {};
        
        window.addEventListener('DOMContentLoaded',()=>{
            loadAllSettings();
            setDefaultDates();
            loadTickers();
            loadDatabentoDatasetsAndSchemas();
            loadOptionsTickets();
        });
        
        function loadAllSettings(){
            const backendUrl = localStorage.getItem('backendUrl');
            const eodhd = localStorage.getItem('eodhd_key');
            const databento = localStorage.getItem('databento_key');
            const polygon = localStorage.getItem('polygon_key');
            const theta = localStorage.getItem('theta_key');
            
            if(backendUrl) {
                document.getElementById('backendUrl').value = backendUrl;
                API_BASE = backendUrl;
            }
            if(eodhd) document.getElementById('eodhd_key').value = eodhd;
            if(databento) document.getElementById('databento_key').value = databento;
            if(polygon) document.getElementById('polygon_key').value = polygon;
            if(theta) document.getElementById('theta_key').value = theta;
        }
        
        function setDefaultDates(){
            const e=new Date,t=new Date(e.getTime()-2592e6),a=d=>d.toISOString().split('T')[0];
            ['eodhd_hist_start','databento_start','polygon_start','theta_start'].forEach(e=>{document.getElementById(e).value=a(t)});
            ['eodhd_hist_end','databento_end','polygon_end','eodhd_opt_date','theta_end'].forEach(e=>{document.getElementById(e).value=a(new Date)})
        }
        
        async function loadTickers(){
            try{
                const e=await fetch(API_BASE+'/api/config/tickers'),t=await e.json();
                if(!t.success)throw new Error(t.error);
                [...t.primary_tickers,...t.mag7_tickers].forEach(t=>{
                    ['eodhd_hist_ticker','databento_ticker','polygon_ticker','theta_ticker'].forEach(e=>{
                        document.getElementById(e).innerHTML+='<option value="'+t.id+'">'+t.label+'</option>'
                    })
                })
            }catch(e){console.error('Error:',e)}
        }
        
        async function loadDatabentoDatasetsAndSchemas(){
            try{
                const e=await fetch(API_BASE+'/api/config/databento'),t=await e.json();
                if(!t.success)throw new Error(t.error);
                let a=document.getElementById('databento_dataset');
                a.innerHTML='<option>Select...</option>';
                t.datasets.forEach(e=>{a.innerHTML+='<option value="'+e.id+'">'+e.label+'</option>'});
                a=document.getElementById('databento_schema');
                a.innerHTML='<option>Select...</option>';
                t.schemas.forEach(e=>{a.innerHTML+='<option value="'+e.id+'">'+e.label+'</option>'})
            }catch(e){console.error('Error:',e)}
        }
        
        async function loadOptionsTickets(){
            try{
                const e=await fetch(API_BASE+'/api/config/options-tickers'),t=await e.json();
                if(!t.success)throw new Error(t.error);
                let a=document.getElementById('eodhd_opt_ticker');
                a.innerHTML='<option>Select...</option>';
                t.options_tickers.forEach(e=>{a.innerHTML+='<option value="'+e.id+'">'+e.label+'</option>'})
            }catch(e){console.error('Error:',e)}
        }
        
        function openSettings(){document.getElementById('settingsModal').classList.add('active')}
        function closeSettings(){document.getElementById('settingsModal').classList.remove('active')}
        
        async function saveSettings(){
            const backendUrl = document.getElementById('backendUrl').value.trim();
            if(!backendUrl) {
                showStatus('settingsStatus', 'Please enter backend URL', 'error');
                return;
            }
            
            localStorage.setItem('backendUrl', backendUrl);
            API_BASE = backendUrl;
            
            localStorage.setItem('eodhd_key', document.getElementById('eodhd_key').value);
            localStorage.setItem('databento_key', document.getElementById('databento_key').value);
            localStorage.setItem('polygon_key', document.getElementById('polygon_key').value);
            localStorage.setItem('theta_key', document.getElementById('theta_key').value);
            
            const e=[
                {name:'eodhd',value:document.getElementById('eodhd_key').value},
                {name:'databento',value:document.getElementById('databento_key').value},
                {name:'polygon',value:document.getElementById('polygon_key').value},
                {name:'theta',value:document.getElementById('theta_key').value}
            ];
            
            for(const t of e)
                if(t.value)
                    try{
                        const a=await fetch(API_BASE+'/api/keys',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:t.name,key:t.value})}),n=await a.json();
                        if(!n.success)throw new Error(n.error)
                    }catch(e){return void showStatus('settingsStatus','Error: '+e.message,'error')}
            
            showStatus('settingsStatus','‚úì All settings saved!','success');
            setTimeout(()=>{loadTickers();loadDatabentoDatasetsAndSchemas();loadOptionsTickets()},500)
        }
        
        function clearAllSettings(){
            if(confirm('Are you sure? This will delete all saved API keys!')){
                localStorage.clear();
                document.getElementById('backendUrl').value = '';
                document.getElementById('eodhd_key').value = '';
                document.getElementById('databento_key').value = '';
                document.getElementById('polygon_key').value = '';
                document.getElementById('theta_key').value = '';
                showStatus('settingsStatus','‚úì All data cleared!','success');
            }
        }
        
        async function testConnection(){
            try{
                const e=await fetch(API_BASE+'/api/health'),t=await e.json();
                if(t.success){
                    const e=Object.entries(t.providers).map(([e,t])=>(t?'‚úì':'‚úó')+' '+e).join(' | ');
                    showStatus('settingsStatus','‚úì Connected! '+e,'success')
                }else throw new Error(t.error)
            }catch(e){showStatus('settingsStatus','‚úó Failed: '+e.message,'error')}
        }
        
        async function fetchEODHDHistorical(){
            const e=document.getElementById('eodhd_hist_ticker').value;
            if(!e)return void alert('Select ticker');
            await fetchData('eodhd-historical',API_BASE+'/api/data/eodhd/historical',{ticker:e,start:document.getElementById('eodhd_hist_start').value,end:document.getElementById('eodhd_hist_end').value})
        }
        
        async function fetchEODHDOptions(){
            const e=document.getElementById('eodhd_opt_ticker').value;
            if(!e)return void alert('Select ticker');
            await fetchData('eodhd-options',API_BASE+'/api/data/eodhd/options',{ticker:e,date:document.getElementById('eodhd_opt_date').value})
        }
        
        async function fetchDatabento(){
            const e=document.getElementById('databento_ticker').value;
            if(!e)return void alert('Select ticker');
            await fetchData('databento',API_BASE+'/api/data/databento/historical',{ticker:e,dataset:document.getElementById('databento_dataset').value,schema:document.getElementById('databento_schema').value,start:document.getElementById('databento_start').value,end:document.getElementById('databento_end').value})
        }
        
        async function fetchPolygon(){
            const e=document.getElementById('polygon_ticker').value;
            if(!e)return void alert('Select ticker');
            await fetchData('polygon',API_BASE+'/api/data/polygon/historical',{ticker:e,timespan:document.getElementById('polygon_timespan').value,start:document.getElementById('polygon_start').value,end:document.getElementById('polygon_end').value})
        }
        
        async function fetchTheta(){
            const e=document.getElementById('theta_ticker').value;
            if(!e)return void alert('Select ticker');
            await fetchData('theta',API_BASE+'/api/data/theta/options',{ticker:e,option_type:document.getElementById('theta_option_type').value,start:document.getElementById('theta_start').value,end:document.getElementById('theta_end').value})
        }
        
        async function fetchData(e,t,a){
            document.getElementById(e+'-loading').classList.add('active');
            document.getElementById(e+'-results').classList.add('hidden');
            try{
                const n=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(a)}),s=await n.json();
                if(!s.success)throw new Error(s.error);
                cachedData[e] = s;
                displayResults(e+'-results',s,e)
            }catch(t){
                document.getElementById(e+'-results').innerHTML='<div class="error-msg">Error: '+t.message+'</div>';
                document.getElementById(e+'-results').classList.remove('hidden')
            }finally{
                document.getElementById(e+'-loading').classList.remove('active')
            }
        }
        
        function downloadCSV(tabId) {
            const data = cachedData[tabId];
            if (!data || !data.data || !Array.isArray(data.data) || data.data.length === 0) {
                alert('No data to download!');
                return;
            }
            
            const rows = data.data;
            const headers = Object.keys(rows[0]);
            let csv = headers.join(',') + '\n';
            
            rows.forEach(row => {
                const values = headers.map(header => {
                    const val = row[header];
                    return typeof val === 'string' && val.includes(',') ? '"' + val + '"' : val;
                });
                csv += values.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${data.provider}_${data.ticker}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function downloadJSON(tabId) {
            const data = cachedData[tabId];
            if (!data || !data.data) {
                alert('No data to download!');
                return;
            }
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${data.provider}_${data.ticker}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function displayResults(e,t,tabId){
            const a=document.getElementById(e);
            if(t.data&&Array.isArray(t.data)&&t.data.length>0){
                let n='<h3>Results ('+t.count+')</h3>';
                n+='<div class="download-section"><h3><i class="fas fa-cloud-download-alt"></i> Download Fetched Data</h3>';
                n+='<div class="download-btns">';
                n+='<button class="btn-download" onclick="downloadCSV(\''+tabId+'\')"><i class="fas fa-file-csv"></i> Download as CSV</button>';
                n+='<button class="btn-download" onclick="downloadJSON(\''+tabId+'\')"><i class="fas fa-file-code"></i> Download as JSON</button>';
                n+='</div></div>';
                n+='<div class="results-container">';
                const s=10;
                for(let e=0;e<t.data.length;e+=s){
                    const d=t.data.slice(e,e+s),i=Math.floor(e/s)+1;
                    n+='<div class="result-card"><div class="result-card-header"><i class="fas fa-layer-group"></i><strong>'+t.provider.toUpperCase()+' - Batch '+i+'</strong></div><div class="result-card-content"><table><thead><tr>';
                    const o=Object.keys(d[0]);
                    o.forEach(e=>{n+='<th>'+e+'</th>'}),n+='</tr></thead><tbody>';
                    d.forEach(e=>{n+='<tr>',o.forEach(t=>{const a=JSON.stringify(e[t]).substring(0,50);n+='<td title="'+JSON.stringify(e[t])+'">'+a+'</td>'}),n+='</tr>'}),n+='</tbody></table></div></div>'
                }
                n+='</div>',a.innerHTML=n
            }else a.innerHTML='<div class="result-card"><pre>'+JSON.stringify(t,null,2)+'</pre></div>';
            a.classList.remove('hidden')
        }
        
        function switchTab(e){
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById(e).classList.add('active');
            event.target.closest('.tab-btn').classList.add('active')
        }
        
        function showStatus(e,t,a){const n=document.getElementById(e);n.className='status '+a,n.innerHTML=t}
    </script>
</body>
</html>
